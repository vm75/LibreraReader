diff --git a/.gitignore b/.gitignore
index 895948373..39bd5f858 100644
--- a/.gitignore
+++ b/.gitignore
@@ -46,3 +46,9 @@ platform/win32/Release
 platform/win32/ReleaseOpenssl
 platform/win32/Memento
 platform/win32/x64
+platform/win32/.vs
+platform/c++
+__pycache__
+platform/python/*_swig.*
+platform/python/include
+platform/wasm/libmupdf.*
diff --git a/.gitmodules b/.gitmodules
index ed3ca68e3..7d061f78f 100644
--- a/.gitmodules
+++ b/.gitmodules
@@ -40,3 +40,6 @@
 [submodule "thirdparty/extract"]
 	path = thirdparty/extract
 	url = ../extract.git
+[submodule "thirdparty/libwebp"]
+	path = thirdparty/libwebp
+	url = https://github.com/webmproject/libwebp.git
diff --git a/Android.mk b/Android.mk
new file mode 100644
index 000000000..4de083a14
--- /dev/null
+++ b/Android.mk
@@ -0,0 +1,329 @@
+# Android makefile to be used with ndk-build.
+#
+# Run ndk-build with the following arguments:
+#	APP_BUILD_SCRIPT=platform/java/Android.mk (this file)
+#	APP_PROJECT_DIR=build/android (where you want the output)
+#	APP_PLATFORM=android-16
+#	APP_OPTIM=release (or debug)
+#	APP_ABI=all (or armeabi, armeabi-v7a, arm64-v8a, x86, x86_64, mips, mips64)
+#
+# The top-level Makefile will invoke ndk-build with appropriate arguments
+# if you run 'make android'.
+#
+# Use the MUPDF_EXTRA_CFLAGS, MUPDF_EXTRA_CPPFLAGS, MUPDF_EXTRA_LDFLAGS,
+# and MUPDF_EXTRA_LDLIBS variables to add more compiler flags.
+#
+# LOCAL_C_INCLUDES paths are relative to the NDK root directory.
+# LOCAL_SRC_FILES paths are relative to LOCAL_PATH.
+#
+# We make sure to use absolute paths everywhere, so this makefile works
+# regardless of where it is called from.
+
+LOCAL_PATH := $(call my-dir)
+include $(CLEAR_VARS)
+
+include $(LIBWEBP_ROOT)/Android.mk
+include $(CLEAR_VARS)
+
+ifeq ($(TARGET_ARCH_ABI),arm64-v8a)
+HAVE_NEON := yes
+endif
+
+ifeq ($(TARGET_ARCH_ABI),x86_64)
+HAVE_AVX := yes
+HAVE_AVX2 := yes
+HAVE_FMA := yes
+HAVE_SSE4_1 := yes
+endif
+
+include $(MUPDF_ROOT)/Makelists
+include $(CLEAR_VARS)
+
+# --- Build a local static library for core mupdf ---
+
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+LOCAL_MODULE := mupdf_core
+
+LOCAL_C_INCLUDES := $(MUPDF_ROOT)/include $(LIBWEBP_ROOT)/src
+
+LOCAL_CFLAGS := \
+	-ffunction-sections -fdata-sections \
+	-D_FILE_OFFSET_BITS=32 \
+	-DNOTO_SMALL \
+	-DAA_BITS=8 \
+	-DOPJ_STATIC -DOPJ_HAVE_INTTYPES_H -DOPJ_HAVE_STDINT_H \
+	-DHAVE_LCMS2MT \
+
+LOCAL_CFLAGS += -fPIC
+
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(FREETYPE_CFLAGS)))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(GUMBO_CFLAGS)))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(HARFBUZZ_CFLAGS)))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(JBIG2DEC_CFLAGS)))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(LCMS2_CFLAGS)))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(LIBJPEG_CFLAGS)))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(MUJS_CFLAGS)))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(OPENJPEG_CFLAGS)))
+
+ifdef USE_TESSERACT
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(TESSERACT_CFLAGS)))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(LEPTONICA_CFLAGS)))
+endif
+
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(EXTRACT_CFLAGS)))
+
+LOCAL_CFLAGS += $(filter-out -I%,$(FREETYPE_CFLAGS))
+LOCAL_CFLAGS += $(filter-out -I%,$(GUMBO_CFLAGS))
+LOCAL_CFLAGS += $(filter-out -I%,$(HARFBUZZ_CFLAGS))
+LOCAL_CFLAGS += $(filter-out -I%,$(JBIG2DEC_CFLAGS))
+LOCAL_CFLAGS += $(filter-out -I%,$(LCMS2_CFLAGS))
+LOCAL_CFLAGS += $(filter-out -I%,$(LIBJPEG_CFLAGS))
+LOCAL_CFLAGS += $(filter-out -I%,$(MUJS_CFLAGS))
+LOCAL_CFLAGS += $(filter-out -I%,$(OPENJPEG_CFLAGS))
+
+ifdef USE_TESSERACT
+LOCAL_CFLAGS += -DHAVE_LEPTONICA -DHAVE_TESSERACT
+LOCAL_CFLAGS += $(filter-out -I%,$(TESSERACT_CFLAGS))
+LOCAL_CFLAGS += $(filter-out -I%,$(LEPTONICA_CFLAGS))
+endif
+
+LOCAL_CFLAGS += $(filter-out -I%,$(EXTRACT_CFLAGS))
+
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/source/fitz/*.c)
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/source/fitz/*.cpp)
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/source/pdf/*.c)
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/source/xps/*.c)
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/source/svg/*.c)
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/source/cbz/*.c)
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/source/html/*.c)
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/source/helpers/pkcs7/*.c)
+
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/generated/resources/fonts/urw/*.c)
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/generated/resources/fonts/noto/*.c)
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/generated/resources/fonts/sil/*.c)
+LOCAL_SRC_FILES += $(wildcard $(MUPDF_ROOT)/generated/resources/fonts/droid/*.c)
+
+
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+
+include $(BUILD_STATIC_LIBRARY)
+
+# --- Build local static libraries for thirdparty libraries ---
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+LOCAL_MODULE += mupdf_thirdparty_freetype
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_ROOT)/%,$(FREETYPE_SRC))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(FREETYPE_CFLAGS) $(FREETYPE_BUILD_CFLAGS)))
+LOCAL_CFLAGS += $(filter-out -I%,$(FREETYPE_CFLAGS) $(FREETYPE_BUILD_CFLAGS))
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+include $(BUILD_STATIC_LIBRARY)
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+LOCAL_MODULE += mupdf_thirdparty_gumbo
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_ROOT)/%,$(GUMBO_SRC))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(GUMBO_CFLAGS) $(GUMBO_BUILD_CFLAGS)))
+LOCAL_CFLAGS += $(filter-out -I%,$(GUMBO_CFLAGS) $(GUMBO_BUILD_CFLAGS))
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+include $(BUILD_STATIC_LIBRARY)
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+LOCAL_MODULE += mupdf_thirdparty_jbig2dec
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_ROOT)/%,$(JBIG2DEC_SRC))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(JBIG2DEC_CFLAGS) $(JBIG2DEC_BUILD_CFLAGS)))
+LOCAL_CFLAGS += $(filter-out -I%,$(JBIG2DEC_CFLAGS) $(JBIG2DEC_BUILD_CFLAGS))
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+include $(BUILD_STATIC_LIBRARY)
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+LOCAL_MODULE += mupdf_thirdparty_harfbuzz
+LOCAL_CPP_EXTENSION := .cc
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_ROOT)/%,$(HARFBUZZ_SRC))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(HARFBUZZ_CFLAGS) $(HARFBUZZ_BUILD_CFLAGS)))
+LOCAL_CPPFLAGS += $(filter-out -I%,$(HARFBUZZ_CFLAGS) $(HARFBUZZ_BUILD_CFLAGS))
+LOCAL_CPPFLAGS += $(MUPDF_EXTRA_CPPFLAGS)
+include $(BUILD_STATIC_LIBRARY)
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+LOCAL_MODULE += mupdf_thirdparty_lcms2
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_ROOT)/%,$(LCMS2_SRC))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(LCMS2_CFLAGS) $(LCMS2_BUILD_CFLAGS)))
+LOCAL_CFLAGS += $(filter-out -I%,$(LCMS2_CFLAGS) $(LCMS2_BUILD_CFLAGS))
+include $(BUILD_STATIC_LIBRARY)
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+LOCAL_MODULE += mupdf_thirdparty_libjpeg
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_ROOT)/%,$(LIBJPEG_SRC))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(LIBJPEG_CFLAGS) $(LIBJPEG_BUILD_CFLAGS)))
+LOCAL_CFLAGS += $(filter-out -I%,$(LIBJPEG_CFLAGS) $(LIBJPEG_BUILD_CFLAGS))
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+include $(BUILD_STATIC_LIBRARY)
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+LOCAL_MODULE += mupdf_thirdparty_mujs
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_ROOT)/%,$(MUJS_SRC))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(MUJS_CFLAGS) $(MUJS_BUILD_CFLAGS)))
+LOCAL_CFLAGS += $(filter-out -I%,$(MUJS_CFLAGS) $(MUJS_BUILD_CFLAGS))
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+include $(BUILD_STATIC_LIBRARY)
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+LOCAL_MODULE += mupdf_thirdparty_openjpeg
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_ROOT)/%,$(OPENJPEG_SRC))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(OPENJPEG_CFLAGS) $(OPENJPEG_BUILD_CFLAGS)))
+LOCAL_CFLAGS += $(filter-out -I%,$(OPENJPEG_CFLAGS) $(OPENJPEG_BUILD_CFLAGS))
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+include $(BUILD_STATIC_LIBRARY)
+
+ifdef USE_TESSERACT
+# --- Build local static libraries for tesseract and leptonica ---
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+LOCAL_MODULE += mupdf_thirdparty_tesseract
+LOCAL_C_INCLUDES := $(MUPDF_ROOT)/include $(LIBWEBP_ROOT)/src
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_ROOT)/%,$(TESSERACT_SRC))
+LOCAL_SRC_FILES += $(MUPDF_ROOT)/source/fitz/tessocr.cpp
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(TESSERACT_CFLAGS) $(TESSERACT_BUILD_CFLAGS)))
+LOCAL_CFLAGS += $(filter-out -I%,$(TESSERACT_CFLAGS) $(TESSERACT_BUILD_CFLAGS))
+LOCAL_CFLAGS += -Wno-sign-compare
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+LOCAL_CPP_FEATURES := exceptions
+include $(BUILD_STATIC_LIBRARY)
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+LOCAL_MODULE += mupdf_thirdparty_leptonica
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_ROOT)/%,$(LEPTONICA_SRC))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(LEPTONICA_CFLAGS) $(LEPTONICA_BUILD_CFLAGS)))
+LOCAL_CFLAGS += $(filter-out -I%,$(LEPTONICA_CFLAGS) $(LEPTONICA_BUILD_CFLAGS))
+LOCAL_CFLAGS += -Wno-sign-compare -DANDROID_BUILD
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+include $(BUILD_STATIC_LIBRARY)
+
+endif  #  USE_TESSERACT
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+LOCAL_MODULE += mupdf_thirdparty_extract
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_ROOT)/%,$(EXTRACT_SRC))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_ROOT)/%,$(filter -I%,$(EXTRACT_CFLAGS) $(EXTRACT_BUILD_CFLAGS)))
+LOCAL_CFLAGS += $(filter-out -I%,$(EXTRACT_CFLAGS) $(EXTRACT_BUILD_CFLAGS))
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+include $(BUILD_STATIC_LIBRARY)
+
+# --- Build the final JNI shared library ---
+
+include $(CLEAR_VARS)
+
+LOCAL_CFLAGS    := $(APP_CFLAGS)
+LOCAL_CPPFLAGS  := $(APP_CPPFLAGS)
+LOCAL_ARM_MODE  := $(APP_ARM_MODE)
+
+
+
+LOCAL_MODULE := mupdf_java
+
+LOCAL_C_INCLUDES += $(MUPDF_ROOT)/include
+
+LOCAL_CFLAGS += -DHAVE_ANDROID
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+
+LOCAL_SRC_FILES += $(MUPDF_ROOT)/platform/java/mupdf_native.c
+
+LOCAL_STATIC_LIBRARIES += webpmux webpdemux webp
+LOCAL_STATIC_LIBRARIES += mupdf_core
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_freetype
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_gumbo
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_harfbuzz
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_jbig2dec
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_lcms2
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_libjpeg
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_mujs
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_openjpeg
+
+
+ifdef USE_TESSERACT
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_leptonica
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_tesseract
+endif
+
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_extract
+
+LOCAL_LDLIBS += $(MUPDF_EXTRA_LDLIBS)
+LOCAL_LDLIBS += -ljnigraphics
+LOCAL_LDLIBS += -llog
+LOCAL_LDLIBS += -lz
+LOCAL_LDLIBS += -lm
+
+LOCAL_LDFLAGS := -Wl,--gc-sections
+LOCAL_LDFLAGS += $(MUPDF_EXTRA_LDFLAGS)
+
+include $(BUILD_SHARED_LIBRARY)
diff --git a/Makelists b/Makelists
index 548bcbe72..9f01e51e0 100644
--- a/Makelists
+++ b/Makelists
@@ -218,6 +218,58 @@ LCMS2_SRC += thirdparty/lcms2/src/cmsvirt.c
 LCMS2_SRC += thirdparty/lcms2/src/cmswtpnt.c
 LCMS2_SRC += thirdparty/lcms2/src/cmsxform.c
 
+# --- LIBWEBP ---
+
+LIBWEBP_CFLAGS += -Ithirdparty/libwebp -Ithirdparty/libwebp/src
+
+LIBWEBP_SRC += thirdparty/libwebp/src/dec/alpha_dec.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dec/buffer_dec.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dec/frame_dec.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dec/idec_dec.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dec/io_dec.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dec/quant_dec.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dec/tree_dec.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dec/vp8_dec.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dec/vp8l_dec.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dec/webp_dec.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/alpha_processing_neon.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/alpha_processing_sse2.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/alpha_processing_sse41.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/alpha_processing.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/cpu.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/dec_clip_tables.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/dec_neon.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/dec_sse2.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/dec_sse41.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/dec.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/filters_neon.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/filters_sse2.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/filters.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/lossless_neon.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/lossless_sse2.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/lossless_sse41.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/lossless.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/rescaler_neon.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/rescaler_sse2.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/rescaler.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/upsampling_neon.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/upsampling_sse2.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/upsampling_sse41.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/upsampling.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/yuv_neon.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/yuv_sse2.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/yuv_sse41.c
+LIBWEBP_SRC += thirdparty/libwebp/src/dsp/yuv.c
+LIBWEBP_SRC += thirdparty/libwebp/src/utils/bit_reader_utils.c
+LIBWEBP_SRC += thirdparty/libwebp/src/utils/color_cache_utils.c
+LIBWEBP_SRC += thirdparty/libwebp/src/utils/huffman_utils.c
+LIBWEBP_SRC += thirdparty/libwebp/src/utils/quant_levels_dec_utils.c
+LIBWEBP_SRC += thirdparty/libwebp/src/utils/random_utils.c
+LIBWEBP_SRC += thirdparty/libwebp/src/utils/rescaler_utils.c
+LIBWEBP_SRC += thirdparty/libwebp/src/utils/thread_utils.c
+LIBWEBP_SRC += thirdparty/libwebp/src/utils/utils.c
+LIBWEBP_SRC += thirdparty/libwebp/src/demux/demux.c
+
 # --- MUJS ---
 
 MUJS_CFLAGS += -Ithirdparty/mujs
diff --git a/Makerules b/Makerules
index 8b5d3e9ce..63d613682 100644
--- a/Makerules
+++ b/Makerules
@@ -123,6 +123,7 @@ SYS_JBIG2DEC_LIBS := -ljbig2dec
 SYS_JPEGXR_LIBS := -ljpegxr
 SYS_LCMS2_LIBS := -llcms2
 SYS_LIBJPEG_LIBS := -ljpeg
+SYS_LIBWEBP_LIBS := -lwebp -lwebpdemux
 SYS_MUJS_LIBS := -lmujs
 SYS_OPENJPEG_LIBS := -lopenjp2
 SYS_ZLIB_LIBS := -lz
diff --git a/Makethird b/Makethird
index cbf12486b..072d20ef0 100644
--- a/Makethird
+++ b/Makethird
@@ -8,6 +8,7 @@ ifeq ($(USE_SYSTEM_LIBS),yes)
   USE_SYSTEM_JPEGXR := no # not available
   USE_SYSTEM_LCMS2 := no # lcms2mt is strongly preferred
   USE_SYSTEM_LIBJPEG := yes
+  USE_SYSTEM_LIBWEBP := yes
   USE_SYSTEM_MUJS := no # not available
   USE_SYSTEM_OPENJPEG := yes
   USE_SYSTEM_ZLIB := yes
@@ -115,6 +116,19 @@ $(OUT)/thirdparty/libjpeg/%.o: thirdparty/libjpeg/%.c
 	$(CC_CMD) $(LIB_CFLAGS) $(LIBJPEG_CFLAGS) $(LIBJPEG_BUILD_CFLAGS)
 endif
 
+# --- LIBWEBP ---
+
+ifeq ($(USE_SYSTEM_LIBWEBP),yes)
+  THIRD_CFLAGS += $(SYS_LIBWEBP_CFLAGS)
+  THIRD_LIBS += $(SYS_LIBWEBP_LIBS)
+else
+  THIRD_CFLAGS += $(LIBWEBP_CFLAGS)
+  THIRD_LIBS += $(LIBWEBP_LIBS)
+  THIRD_SRC += $(LIBWEBP_SRC)
+$(OUT)/thirdparty/libwebp/%.o: thirdparty/libwebp/%.c
+	$(CC_CMD) $(LIB_CFLAGS) $(LIBWEBP_CFLAGS) $(LIBWEBP_BUILD_CFLAGS)
+endif
+
 # --- LCMS2 ---
 
 ifeq ($(USE_SYSTEM_LCMS2),yes)
diff --git a/docs/building.html b/docs/building.html
index 8266bf211..1ad058935 100644
--- a/docs/building.html
+++ b/docs/building.html
@@ -62,9 +62,9 @@ On Windows there is a Visual Studio project file in <tt>platform/win32/mupdf.vcp
 
 <p>
 If you are compiling from source you will need several third party libraries:
-freetype2, jbig2dec, libjpeg, openjpeg, and zlib. These libraries are contained
-in the source archive. If you are using git, they are included as git
-submodules.
+freetype2, jbig2dec, libjpeg, libwebp, openjpeg, and zlib. These libraries are
+contained in the source archive. If you are using git, they are included as
+git submodules.
 
 <p>
 You will also need the X11 headers and libraries if you're building on Linux.
diff --git a/docs/thirdparty.html b/docs/thirdparty.html
index 73a16d227..23a672520 100644
--- a/docs/thirdparty.html
+++ b/docs/thirdparty.html
@@ -22,6 +22,7 @@ These are the third party libraries used by MuPDF.
 <tr><td><a href="http://www.freetype.org/">freetype</a><td>2.11.1<td>Font scaling and rendering <td>BSD-style
 <tr><td><a href="http://www.harfbuzz.org/">harfbuzz</a><td>2.7.4 <td>Text shaping <td>MIT-style
 <tr><td><a href="http://www.ijg.org/">libjpeg</a><td>9.0d with patches <td>JPEG decoding <td>BSD-style
+<tr><td><a href="https://www.webmproject.org/">libwebp</a><td>1.2.2 <td>WEBP decoding <td>BSD-style
 <tr><td><a href="http://git.ghostscript.com/?p=thirdparty-lcms2.git;a=summary">Incompatible fork of lcms2</a><td>2.9 with patches<td>Color management <td>MIT-style
 <tr><td><a href="http://www.openjpeg.org/">openjpeg</a><td>2.4.0<td>JPEG 2000 decoding <td>BSD-style
 <tr><td><a href="http://www.zlib.net/">zlib</a><td>1.2.12<td>Deflate compression <td>zlib License
diff --git a/include/mupdf/fitz/compressed-buffer.h b/include/mupdf/fitz/compressed-buffer.h
index 852648c61..22eb22dd6 100644
--- a/include/mupdf/fitz/compressed-buffer.h
+++ b/include/mupdf/fitz/compressed-buffer.h
@@ -146,6 +146,7 @@ enum
 	FZ_IMAGE_PNG,
 	FZ_IMAGE_PNM,
 	FZ_IMAGE_TIFF,
+	FZ_IMAGE_WEBP,
 };
 
 /**
diff --git a/platform/java/Android.mk b/platform/java/Android.mk
index 308e57a7f..1ec094c12 100644
--- a/platform/java/Android.mk
+++ b/platform/java/Android.mk
@@ -56,6 +56,7 @@ LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_PATH)/%,$(filter -I%,$(HARFBUZZ_CFLAG
 LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_PATH)/%,$(filter -I%,$(JBIG2DEC_CFLAGS)))
 LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_PATH)/%,$(filter -I%,$(LCMS2_CFLAGS)))
 LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_PATH)/%,$(filter -I%,$(LIBJPEG_CFLAGS)))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_PATH)/%,$(filter -I%,$(LIBWEBP_CFLAGS)))
 LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_PATH)/%,$(filter -I%,$(MUJS_CFLAGS)))
 LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_PATH)/%,$(filter -I%,$(OPENJPEG_CFLAGS)))
 
@@ -72,6 +73,7 @@ LOCAL_CFLAGS += $(filter-out -I%,$(HARFBUZZ_CFLAGS))
 LOCAL_CFLAGS += $(filter-out -I%,$(JBIG2DEC_CFLAGS))
 LOCAL_CFLAGS += $(filter-out -I%,$(LCMS2_CFLAGS))
 LOCAL_CFLAGS += $(filter-out -I%,$(LIBJPEG_CFLAGS))
+LOCAL_CFLAGS += $(filter-out -I%,$(LIBWEBP_CFLAGS))
 LOCAL_CFLAGS += $(filter-out -I%,$(MUJS_CFLAGS))
 LOCAL_CFLAGS += $(filter-out -I%,$(OPENJPEG_CFLAGS))
 
@@ -149,6 +151,14 @@ LOCAL_CFLAGS += $(filter-out -I%,$(LIBJPEG_CFLAGS) $(LIBJPEG_BUILD_CFLAGS))
 LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
 include $(BUILD_STATIC_LIBRARY)
 
+include $(CLEAR_VARS)
+LOCAL_MODULE += mupdf_thirdparty_libwebp
+LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_PATH)/%,$(LIBWEBP_SRC))
+LOCAL_C_INCLUDES += $(patsubst -I%,$(MUPDF_PATH)/%,$(filter -I%,$(LIBWEBP_CFLAGS) $(LIBWEBP_BUILD_CFLAGS)))
+LOCAL_CFLAGS += $(filter-out -I%,$(LIBWEBP_CFLAGS) $(LIBWEBP_BUILD_CFLAGS))
+LOCAL_CFLAGS += $(MUPDF_EXTRA_CFLAGS)
+include $(BUILD_STATIC_LIBRARY)
+
 include $(CLEAR_VARS)
 LOCAL_MODULE += mupdf_thirdparty_mujs
 LOCAL_SRC_FILES += $(patsubst %,$(MUPDF_PATH)/%,$(MUJS_SRC))
@@ -225,6 +235,7 @@ LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_harfbuzz
 LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_jbig2dec
 LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_lcms2
 LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_libjpeg
+LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_libwebp
 LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_mujs
 LOCAL_STATIC_LIBRARIES += mupdf_thirdparty_openjpeg
 
diff --git a/platform/win32/libmupdf.vcxproj b/platform/win32/libmupdf.vcxproj
index 814a2b24e..514eb86f0 100644
--- a/platform/win32/libmupdf.vcxproj
+++ b/platform/win32/libmupdf.vcxproj
@@ -410,7 +410,7 @@
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg/src/lib/openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg/src/lib/openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;_DEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -427,7 +427,7 @@
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='DebugTesseract|Win32'">
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg/src/lib/openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg/src/lib/openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>HAVE_TESSERACT;HAVE_LEPTONICA;WIN32;_DEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -447,7 +447,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;_DEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -466,7 +466,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>HAVE_TESSERACT;HAVE_LEPTONICA;WIN64;_DEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -484,7 +484,7 @@
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
       <WholeProgramOptimization>false</WholeProgramOptimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;NDEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -502,7 +502,7 @@
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
       <WholeProgramOptimization>false</WholeProgramOptimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>HAVE_TESSERACT;HAVE_LEPTONICA;WIN32;NDEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -523,7 +523,7 @@
     <ClCompile>
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;NDEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -541,7 +541,7 @@
     <ClCompile>
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>HAVE_TESSERACT;HAVE_LEPTONICA;WIN64;NDEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -558,7 +558,7 @@
     </PreBuildEvent>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;_DEBUG;MEMENTO=1;MEMENTO_MUPDF_HACKS=1;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -579,7 +579,7 @@
     </PreBuildEvent>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;_DEBUG;MEMENTO=1;MEMENTO_MUPDF_HACKS=1;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -600,7 +600,7 @@
     </PreBuildEvent>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>HAVE_TESSERACT;HAVE_LEPTONICA;WIN32;_DEBUG;MEMENTO=1;MEMENTO_MUPDF_HACKS=1;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -623,7 +623,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;_DEBUG;MEMENTO=1;MEMENTO_MUPDF_HACKS=1;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -646,7 +646,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;_DEBUG;MEMENTO=1;MEMENTO_MUPDF_HACKS=1;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -669,7 +669,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>HAVE_TESSERACT;HAVE_LEPTONICA;WIN64;_DEBUG;MEMENTO=1;MEMENTO_MUPDF_HACKS=1;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -688,7 +688,7 @@
     </PreBuildEvent>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\openssl\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\openssl\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;_DEBUG;HAVE_LIBCRYPTO;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -711,7 +711,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\openssl\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\openssl\include;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\openssl\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\openssl\include;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;_DEBUG;HAVE_LIBCRYPTO;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -728,7 +728,7 @@
     <ClCompile>
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\openssl\include;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\openssl\include;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;NDEBUG;HAVE_LIBCRYPTO;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -748,7 +748,7 @@
     <ClCompile>
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\openssl\include;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\openssl\include;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;NDEBUG;HAVE_LIBCRYPTO;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -765,7 +765,7 @@
     </PreBuildEvent>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg/src/lib/openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg/src/lib/openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;_DEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -788,7 +788,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;_DEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -806,7 +806,7 @@
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
       <WholeProgramOptimization>false</WholeProgramOptimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;NDEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -826,7 +826,7 @@
     <ClCompile>
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;NDEBUG;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -843,7 +843,7 @@
     </PreBuildEvent>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;_DEBUG;HAVE_LIBCRYPTO;MEMENTO=1;MEMENTO_MUPDF_HACKS=1;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -866,7 +866,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\include;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp\src;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\mujs;..\..\thirdparty\harfbuzz\src;..\..\thirdparty\lcms2\include;..\..\thirdparty\extract\include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;_DEBUG;HAVE_LIBCRYPTO;MEMENTO=1;MEMENTO_MUPDF_HACKS=1;OPJ_STATIC;HAVE_LCMS2MT=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -951,6 +951,7 @@
     <ClCompile Include="..\..\source\fitz\load-png.c" />
     <ClCompile Include="..\..\source\fitz\load-pnm.c" />
     <ClCompile Include="..\..\source\fitz\load-tiff.c" />
+    <ClCompile Include="..\..\source\fitz\load-webp.c" />
     <ClCompile Include="..\..\source\fitz\log.c" />
     <ClCompile Include="..\..\source\fitz\memento.c" />
     <ClCompile Include="..\..\source\fitz\memory.c" />
diff --git a/platform/win32/libmupdf.vcxproj.filters b/platform/win32/libmupdf.vcxproj.filters
index c953ec4b1..3814d19f7 100644
--- a/platform/win32/libmupdf.vcxproj.filters
+++ b/platform/win32/libmupdf.vcxproj.filters
@@ -294,6 +294,9 @@
     <ClCompile Include="..\..\source\fitz\load-tiff.c">
       <Filter>fitz</Filter>
     </ClCompile>
+    <ClCompile Include="..\..\source\fitz\load-webp.c">
+      <Filter>fitz</Filter>
+    </ClCompile>
     <ClCompile Include="..\..\source\fitz\memento.c">
       <Filter>fitz</Filter>
     </ClCompile>
diff --git a/platform/win32/libthirdparty.vcxproj b/platform/win32/libthirdparty.vcxproj
index 28214b03e..2c058b4f7 100644
--- a/platform/win32/libthirdparty.vcxproj
+++ b/platform/win32/libthirdparty.vcxproj
@@ -214,7 +214,7 @@
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;_DEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";verbose=-1;JBIG_EXTERNAL_MEMENTO_H="memento.h";HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -231,7 +231,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;_DEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";verbose=-1;HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -246,7 +246,7 @@
     <ClCompile>
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;NDEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";verbose=-1;JBIG_EXTERNAL_MEMENTO_H="memento.h";HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -263,7 +263,7 @@
     <ClCompile>
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;NDEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";verbose=-1;HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -275,7 +275,7 @@
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Memento|Win32'">
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;_DEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";MEMENTO=1;verbose=-1;JBIG_EXTERNAL_MEMENTO_H="memento.h";HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -289,7 +289,7 @@
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='MementoDLL|Win32'">
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;_DEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";MEMENTO=1;verbose=-1;JBIG_EXTERNAL_MEMENTO_H="memento.h";HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -306,7 +306,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;_DEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";MEMENTO=1;verbose=-1;HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -323,7 +323,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;_DEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";MEMENTO=1;verbose=-1;HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -337,7 +337,7 @@
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='DebugDLL|Win32'">
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;_DEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";verbose=-1;JBIG_EXTERNAL_MEMENTO_H="memento.h";HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -354,7 +354,7 @@
     </Midl>
     <ClCompile>
       <Optimization>Disabled</Optimization>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;_DEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";verbose=-1;HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <MinimalRebuild>
       </MinimalRebuild>
@@ -369,7 +369,7 @@
     <ClCompile>
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN32;NDEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";verbose=-1;JBIG_EXTERNAL_MEMENTO_H="memento.h";HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -386,7 +386,7 @@
     <ClCompile>
       <Optimization>MaxSpeed</Optimization>
       <IntrinsicFunctions>true</IntrinsicFunctions>
-      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <AdditionalIncludeDirectories>..\..\thirdparty\lcms2\include;..\..\scripts\freetype;..\..\scripts\libjpeg;..\..\thirdparty\jbig2dec;..\..\thirdparty\libjpeg;..\..\thirdparty\libwebp;..\..\thirdparty\openjpeg\src\lib\openjp2;..\..\thirdparty\zlib;..\..\thirdparty\freetype\include;..\..\thirdparty\freetype\include\freetype;..\..\thirdparty\gumbo-parser\src;..\..\thirdparty\gumbo-parser\visualc\include;..\..\include\;..\..\include\mupdf;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
       <PreprocessorDefinitions>WIN64;NDEBUG;_CRT_SECURE_NO_WARNINGS;FT2_BUILD_LIBRARY;OPJ_STATIC;USE_JPIP=1;FT_CONFIG_MODULES_H="slimftmodules.h";FT_CONFIG_OPTIONS_H="slimftoptions.h";verbose=-1;HAVE_FALLBACK=1;HAVE_OT;HAVE_UCDN;HB_NO_MT;hb_malloc_impl=fz_hb_malloc;hb_calloc_impl=fz_hb_calloc;hb_realloc_impl=fz_hb_realloc;hb_free_impl=fz_hb_free;HAVE_FREETYPE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>
       <FunctionLevelLinking>true</FunctionLevelLinking>
@@ -552,6 +552,53 @@
     <ClCompile Include="..\..\thirdparty\libjpeg\jquant1.c" />
     <ClCompile Include="..\..\thirdparty\libjpeg\jquant2.c" />
     <ClCompile Include="..\..\thirdparty\libjpeg\jutils.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\alpha_dec.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\buffer_dec.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\frame_dec.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\idec_dec.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\io_dec.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\quant_dec.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\tree_dec.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\vp8_dec.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\vp8l_dec.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\webp_dec.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\alpha_processing_neon.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\alpha_processing_sse2.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\alpha_processing_sse41.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\alpha_processing.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\cpu.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\dec_clip_tables.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\dec_neon.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\dec_sse2.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\dec_sse41.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\dec.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\filters_neon.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\filters_sse2.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\filters.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\lossless_neon.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\lossless_sse2.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\lossless_sse41.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\lossless.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\rescaler_neon.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\rescaler_sse2.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\rescaler.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\upsampling_neon.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\upsampling_sse2.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\upsampling_sse41.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\upsampling.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\yuv_neon.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\yuv_sse2.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\yuv_sse41.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\yuv.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\bit_reader_utils.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\color_cache_utils.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\huffman_utils.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\quant_levels_dec_utils.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\random_utils.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\rescaler_utils.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\thread_utils.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\utils.c" />
+    <ClCompile Include="..\..\thirdparty\libwebp\src\demux\demux.c" />
     <ClCompile Include="..\..\thirdparty\mujs\jsarray.c">
       <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='DebugDLL|Win32'">true</ExcludedFromBuild>
       <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">true</ExcludedFromBuild>
@@ -1303,4 +1350,4 @@
   <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
   <ImportGroup Label="ExtensionTargets">
   </ImportGroup>
-</Project>
\ No newline at end of file
+</Project>
diff --git a/platform/win32/libthirdparty.vcxproj.filters b/platform/win32/libthirdparty.vcxproj.filters
index 029a175b6..8addaf7fb 100644
--- a/platform/win32/libthirdparty.vcxproj.filters
+++ b/platform/win32/libthirdparty.vcxproj.filters
@@ -37,6 +37,9 @@
     <Filter Include="libmujs">
       <UniqueIdentifier>{2922f483-1012-471b-86cf-f7b14cc6367c}</UniqueIdentifier>
     </Filter>
+    <Filter Include="libwebp">
+      <UniqueIdentifier>{69f5afe0-2f47-4eb6-b59e-bcb1766f13df}</UniqueIdentifier>
+    </Filter>
     <Filter Include="harfbuzz">
       <UniqueIdentifier>{0c24b1d0-ff40-41ab-8769-0a9a63175c12}</UniqueIdentifier>
     </Filter>
@@ -1196,5 +1199,146 @@
     <ClInclude Include="..\..\thirdparty\mujs\utf.h">
       <Filter>libmujs</Filter>
     </ClInclude>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\alpha_dec.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\buffer_dec.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\frame_dec.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\idec_dec.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\io_dec.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\quant_dec.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\tree_dec.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\vp8_dec.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\vp8l_dec.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dec\webp_dec.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\alpha_processing_neon.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\alpha_processing_sse2.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\alpha_processing_sse41.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\alpha_processing.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\cpu.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\dec_clip_tables.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\dec_neon.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\dec_sse2.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\dec_sse41.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\dec.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\filters_neon.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\filters_sse2.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\filters.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\lossless_neon.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\lossless_sse2.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\lossless_sse41.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\lossless.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\rescaler_neon.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\rescaler_sse2.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\rescaler.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\upsampling_neon.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\upsampling_sse2.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\upsampling_sse41.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\upsampling.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\yuv_neon.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\yuv_sse2.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\yuv_sse41.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\dsp\yuv.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\bit_reader_utils.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\color_cache_utils.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\huffman_utils.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\quant_levels_dec_utils.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\random_utils.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\rescaler_utils.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\thread_utils.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\utils\utils.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
+    <ClCompile Include="..\..\thirdparty\libwebp\src\demux\demux.c">
+      <Filter>libwebp</Filter>
+    </ClCompile>
   </ItemGroup>
-</Project>
\ No newline at end of file
+</Project>
diff --git a/source/cbz/mucbz.c b/source/cbz/mucbz.c
index 76e80550b..02a7d20e8 100644
--- a/source/cbz/mucbz.c
+++ b/source/cbz/mucbz.c
@@ -49,6 +49,7 @@ static const char *cbz_ext_list[] = {
 	".tif",
 	".tiff",
 	".wdp",
+	".webp",
 	NULL
 };
 
@@ -142,6 +143,45 @@ cbz_create_page_list(fz_context *ctx, cbz_document *doc)
 	qsort((char **)doc->page, doc->page_count, sizeof *doc->page, cbz_compare_page_names);
 }
 
+static void
+cbz_create_page_list_dir(fz_context *ctx, cbz_document *doc, char *ldir)
+{
+	fz_archive *arch = doc->arch;
+	int i, k, count;
+
+	fz_buffer *buf;
+	fz_xml *container_xml;
+
+	buf = fz_read_archive_entry(ctx, arch, ldir);
+	container_xml = fz_xml_root(fz_parse_xml(ctx, buf, 0));
+	fz_drop_buffer(ctx, buf);
+
+	fz_xml *container;
+	container = fz_xml_find(container_xml, "container");
+
+	const char *version;
+	version = fz_xml_att(container, "count");
+
+	count = fz_atoi(version);
+
+	fz_xml *itemref;
+	itemref = fz_xml_find_down(container_xml, "item");
+
+	doc->page_count = 0;
+	doc->page = fz_malloc_array(ctx, count, const char *);
+
+	while (itemref)
+	{
+		const char *path;
+		path = fz_xml_att(itemref, "path");
+
+		doc->page[doc->page_count++] = path;
+
+		itemref = fz_xml_find_next(itemref, "item");
+	}
+
+}
+
 static void
 cbz_drop_document(fz_context *ctx, fz_document *doc_)
 {
@@ -227,7 +267,12 @@ cbz_load_page(fz_context *ctx, fz_document *doc_, int chapter, int number)
 	fz_var(page);
 
 	if (doc->arch)
-		buf = fz_read_archive_entry(ctx, doc->arch, doc->page[number]);
+	{
+		if (fz_has_archive_entry(ctx, doc->arch, doc->page[number]))
+			buf = fz_read_archive_entry(ctx, doc->arch, doc->page[number]);
+		else
+			buf = fz_read_file(ctx, doc->page[number]);
+	}
 	if (!buf)
 		fz_throw(ctx, FZ_ERROR_GENERIC, "cannot load cbz page");
 
@@ -286,12 +331,69 @@ cbz_open_document_with_stream(fz_context *ctx, fz_stream *file)
 	return (fz_document*)doc;
 }
 
+typedef struct fz_directory_s ffz_directoryz_directory;
+struct fz_directory_s
+{
+	fz_archive super;
+
+	char *path;
+};
+
+
+static fz_document *
+cbz_open_document(fz_context *ctx, const char *filename1)
+{
+	cbz_document *doc;
+
+	doc = fz_new_derived_document(ctx, cbz_document);
+
+	doc->super.drop_document = cbz_drop_document;
+	doc->super.count_pages = cbz_count_pages;
+	doc->super.load_page = cbz_load_page;
+	doc->super.lookup_metadata = cbz_lookup_metadata;
+	if (strstr(filename1, ".ldir"))
+	{
+		char dirname1[2048];
+		fz_dirname(dirname1, filename1, sizeof dirname1);
+
+		fz_try(ctx)
+		{
+			doc->arch = fz_open_directory(ctx, dirname1);
+			char *name;
+			name = strrchr(filename1, '/');
+
+			cbz_create_page_list_dir(ctx, doc, name);
+		}
+		fz_catch(ctx)
+		{
+			fz_drop_document(ctx, (fz_document*)doc);
+			fz_rethrow(ctx);
+		}
+	}
+	else
+	{
+		fz_try(ctx)
+		{
+			doc->arch = fz_open_zip_archive(ctx, filename1);
+			cbz_create_page_list(ctx, doc);
+		}
+		fz_catch(ctx)
+		{
+			fz_drop_document(ctx, (fz_document*)doc);
+			fz_rethrow(ctx);
+		}
+	}
+
+	return (fz_document*)doc;
+}
+
 static const char *cbz_extensions[] =
 {
 	"cbt",
 	"cbz",
 	"tar",
 	"zip",
+	"ldir",
 	NULL
 };
 
@@ -308,7 +410,7 @@ static const char *cbz_mimetypes[] =
 fz_document_handler cbz_document_handler =
 {
 	NULL,
-	NULL,
+	cbz_open_document,
 	cbz_open_document_with_stream,
 	cbz_extensions,
 	cbz_mimetypes,
diff --git a/source/cbz/muimg.c b/source/cbz/muimg.c
index 0edcb0acd..28b259642 100644
--- a/source/cbz/muimg.c
+++ b/source/cbz/muimg.c
@@ -262,6 +262,7 @@ static const char *img_extensions[] =
 	"tif",
 	"tiff",
 	"wdp",
+	"webp",
 	NULL
 };
 
@@ -277,6 +278,7 @@ static const char *img_mimetypes[] =
 	"image/png",
 	"image/tiff",
 	"image/vnd.ms-photo",
+	"image/webp",
 	"image/x-jb2",
 	"image/x-jbig2",
 	"image/x-portable-anymap",
diff --git a/source/fitz/image-imp.h b/source/fitz/image-imp.h
index 140092392..1f1c5b8ac 100644
--- a/source/fitz/image-imp.h
+++ b/source/fitz/image-imp.h
@@ -31,6 +31,7 @@ fz_pixmap *fz_load_gif(fz_context *ctx, const unsigned char *data, size_t size);
 fz_pixmap *fz_load_bmp(fz_context *ctx, const unsigned char *data, size_t size);
 fz_pixmap *fz_load_pnm(fz_context *ctx, const unsigned char *data, size_t size);
 fz_pixmap *fz_load_jbig2(fz_context *ctx, const unsigned char *data, size_t size);
+fz_pixmap *fz_load_webp(fz_context *ctx, const unsigned char *data, size_t size);
 
 void fz_load_jpeg_info(fz_context *ctx, const unsigned char *data, size_t size, int *w, int *h, int *xres, int *yres, fz_colorspace **cspace, uint8_t *orientation);
 void fz_load_jpx_info(fz_context *ctx, const unsigned char *data, size_t size, int *w, int *h, int *xres, int *yres, fz_colorspace **cspace);
@@ -41,5 +42,6 @@ void fz_load_gif_info(fz_context *ctx, const unsigned char *data, size_t size, i
 void fz_load_bmp_info(fz_context *ctx, const unsigned char *data, size_t size, int *w, int *h, int *xres, int *yres, fz_colorspace **cspace);
 void fz_load_pnm_info(fz_context *ctx, const unsigned char *data, size_t size, int *w, int *h, int *xres, int *yres, fz_colorspace **cspace);
 void fz_load_jbig2_info(fz_context *ctx, const unsigned char *data, size_t size, int *w, int *h, int *xres, int *yres, fz_colorspace **cspace);
+void fz_load_webp_info(fz_context *ctx, const unsigned char *data, size_t size, int *w, int *h, int *xres, int *yres, fz_colorspace **cspace);
 
 #endif
diff --git a/source/fitz/image.c b/source/fitz/image.c
index 9668b71a3..ab800412b 100644
--- a/source/fitz/image.c
+++ b/source/fitz/image.c
@@ -757,6 +757,9 @@ compressed_image_get_pixmap(fz_context *ctx, fz_image *image_, fz_irect *subarea
 	case FZ_IMAGE_JPX:
 		tile = fz_load_jpx(ctx, image->buffer->buffer->data, image->buffer->buffer->len, NULL);
 		break;
+	case FZ_IMAGE_WEBP:
+		tile = fz_load_webp(ctx, image->buffer->buffer->data, image->buffer->buffer->len);
+		break;
 	case FZ_IMAGE_JPEG:
 		/* Scan JPEG stream and patch missing height values in header */
 		{
@@ -1206,7 +1209,7 @@ void fz_set_pixmap_image_tile(fz_context *ctx, fz_pixmap_image *image, fz_pixmap
 }
 
 int
-fz_recognize_image_format(fz_context *ctx, unsigned char p[8])
+fz_recognize_image_format(fz_context *ctx, unsigned char p[16])
 {
 	if (p[0] == 'P' && p[1] >= '1' && p[1] <= '7')
 		return FZ_IMAGE_PNM;
@@ -1237,6 +1240,8 @@ fz_recognize_image_format(fz_context *ctx, unsigned char p[8])
 	if (p[0] == 0x97 && p[1] == 'J' && p[2] == 'B' && p[3] == '2' &&
 		p[4] == '\r' && p[5] == '\n'  && p[6] == 0x1a && p[7] == '\n')
 		return FZ_IMAGE_JBIG2;
+	if (!memcmp(p, "RIFF", 4) && !memcmp(p+8, "WEBPVP8 ", 8))
+		return FZ_IMAGE_WEBP;
 	return FZ_IMAGE_UNKNOWN;
 }
 
@@ -1253,7 +1258,7 @@ fz_new_image_from_buffer(fz_context *ctx, fz_buffer *buffer)
 	int bpc;
 	uint8_t orientation = 0;
 
-	if (len < 8)
+	if (len < 16)
 		fz_throw(ctx, FZ_ERROR_GENERIC, "unknown image file format");
 
 	type = fz_recognize_image_format(ctx, buf);
@@ -1288,6 +1293,9 @@ fz_new_image_from_buffer(fz_context *ctx, fz_buffer *buffer)
 		fz_load_jbig2_info(ctx, buf, len, &w, &h, &xres, &yres, &cspace);
 		bpc = 1;
 		break;
+	case FZ_IMAGE_WEBP:
+		fz_load_webp_info(ctx, buf, len, &w, &h, &xres, &yres, &cspace);
+		break;
 	default:
 		fz_throw(ctx, FZ_ERROR_GENERIC, "unknown image file format");
 	}
diff --git a/source/fitz/load-webp.c b/source/fitz/load-webp.c
new file mode 100644
index 000000000..67f37df53
--- /dev/null
+++ b/source/fitz/load-webp.c
@@ -0,0 +1,285 @@
+// Copyright (C) 2004-2022 Artifex Software, Inc.
+//
+// This file is part of MuPDF.
+//
+// MuPDF is free software: you can redistribute it and/or modify it under the
+// terms of the GNU Affero General Public License as published by the Free
+// Software Foundation, either version 3 of the License, or (at your option)
+// any later version.
+//
+// MuPDF is distributed in the hope that it will be useful, but WITHOUT ANY
+// WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
+// FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more
+// details.
+//
+// You should have received a copy of the GNU Affero General Public License
+// along with MuPDF. If not, see <https://www.gnu.org/licenses/agpl-3.0.en.html>
+//
+// Alternative licensing terms are available from the licensor.
+// For commercial licensing, see <https://www.artifex.com/> or contact
+// Artifex Software, Inc., 1305 Grant Avenue - Suite 200, Novato,
+// CA 94945, U.S.A., +1(415)492-9861, for further information.
+
+#include "mupdf/fitz.h"
+
+#include "image-imp.h"
+#include "pixmap-imp.h"
+
+#include <math.h>
+#include <string.h>
+#include <limits.h>
+
+#include <webp/decode.h>
+#include <webp/demux.h>
+#include <webp/types.h>
+
+struct info
+{
+	int width, height;
+	int xres, yres;
+	uint8_t orientation;
+	int pages;
+	fz_colorspace *cs;
+};
+
+/* Returns true if <x> can be represented as an integer without overflow.
+ *
+ * We can't use comparisons such as 'return x < INT_MAX' because INT_MAX is
+ * not safely convertible to float - it ends up as INT_MAX+1 so the comparison
+ * doesn't do what we want.
+ *
+ * Instead we do a round-trip conversion and return true if this differs by
+ * less than 1. This relies on high adjacent float values that differ by more
+ * than 1, actually being exact integers, so the round-trip doesn't change the
+ * value.
+ */
+static int float_can_be_int(float x)
+{
+	return fabsf(x - (float)(int) x) < 1;
+}
+
+static uint8_t exif_orientation_to_mupdf[9] = { 0, 1, 5, 3, 7, 6, 4, 8, 2 };
+
+static inline int read_value(const unsigned char *data, int bytes, int is_big_endian)
+{
+	int value = 0;
+	if (!is_big_endian)
+		data += bytes;
+	for (; bytes > 0; bytes--)
+		value = (value << 8) | (is_big_endian ? *data++ : *--data);
+	return value;
+}
+
+static int extract_exif_resolution(WebPData* chunk,
+	int *xres, int *yres, uint8_t *orientation)
+{
+	int is_big_endian, orient;
+	const unsigned char *data;
+	unsigned int offset, ifd_len, res_type = 0;
+	float x_res = 0, y_res = 0;
+
+	if (!chunk || chunk->size < 14)
+		return 0;
+	data = (const unsigned char *)chunk->bytes;
+	if (read_value(data, 4, 1) != 0x45786966 /* Exif */ || read_value(data + 4, 2, 1) != 0x0000)
+		return 0;
+	if (read_value(data + 6, 4, 1) == 0x49492A00)
+		is_big_endian = 0;
+	else if (read_value(data + 6, 4, 1) == 0x4D4D002A)
+		is_big_endian = 1;
+	else
+		return 0;
+
+	offset = read_value(data + 10, 4, is_big_endian) + 6;
+	if (offset < 14 || offset > chunk->size - 2)
+		return 0;
+	ifd_len = read_value(data + offset, 2, is_big_endian);
+	for (offset += 2; ifd_len > 0 && offset + 12 < chunk->size; ifd_len--, offset += 12)
+	{
+		int tag = read_value(data + offset, 2, is_big_endian);
+		int type = read_value(data + offset + 2, 2, is_big_endian);
+		int count = read_value(data + offset + 4, 4, is_big_endian);
+		unsigned int value_off = read_value(data + offset + 8, 4, is_big_endian) + 6;
+		switch (tag)
+		{
+		case 0x112:
+			if (type == 3 && count == 1) {
+				orient = read_value(data + offset + 8, 2, is_big_endian);
+				if (orient >= 1 && orient <= 8 && orientation)
+					*orientation = exif_orientation_to_mupdf[orient];
+			}
+			break;
+		case 0x11A:
+			if (type == 5 && value_off > offset && value_off <= chunk->size - 8)
+				x_res = 1.0f * read_value(data + value_off, 4, is_big_endian) / read_value(data + value_off + 4, 4, is_big_endian);
+			break;
+		case 0x11B:
+			if (type == 5 && value_off > offset && value_off <= chunk->size - 8)
+				y_res = 1.0f * read_value(data + value_off, 4, is_big_endian) / read_value(data + value_off + 4, 4, is_big_endian);
+			break;
+		case 0x128:
+			if (type == 3 && count == 1)
+				res_type = read_value(data + offset + 8, 2, is_big_endian);
+			break;
+		}
+	}
+
+	if (x_res <= 0 || !float_can_be_int(x_res) || y_res <= 0 || !float_can_be_int(y_res))
+		return 0;
+	if (res_type == 2)
+	{
+		*xres = (int)x_res;
+		*yres = (int)y_res;
+	}
+	else if (res_type == 3)
+	{
+		*xres = (int)(x_res * 254 / 100);
+		*yres = (int)(y_res * 254 / 100);
+	}
+	else
+	{
+		*xres = 0;
+		*yres = 0;
+	}
+	return 1;
+}
+
+static fz_colorspace *extract_icc_profile(fz_context *ctx, WebPData* chunk, fz_colorspace *colorspace)
+{
+#if FZ_ENABLE_ICC
+	fz_buffer *buf = NULL;
+
+	fz_var(buf);
+
+	if (!chunk || !chunk->bytes || chunk->size == 0)
+		return colorspace;
+
+	fz_try(ctx)
+	{
+		buf = fz_new_buffer_from_copied_data(ctx, chunk->bytes, chunk->size);
+		if (buf)
+		{
+			fz_colorspace *icc = fz_new_icc_colorspace(ctx, FZ_COLORSPACE_NONE, 0, NULL, buf);
+			fz_drop_colorspace(ctx, colorspace);
+			colorspace = icc;
+		}
+	}
+	fz_always(ctx)
+		fz_drop_buffer(ctx, buf);
+	fz_catch(ctx)
+		fz_warn(ctx, "ignoring embedded ICC profile in JPEG");
+
+	return colorspace;
+#else
+	return colorspace;
+#endif
+}
+
+static fz_pixmap *
+webp_read_image(fz_context *ctx, struct info *info, const unsigned char *p, size_t total, int only_metadata)
+{
+	fz_pixmap *image = NULL;
+
+	fz_try(ctx)
+	{
+		struct WebPBitstreamFeatures features;
+		WebPData webp_data;
+		WebPDemuxer* demux = NULL;
+
+		if (WebPGetFeatures(p, total, &features) != VP8_STATUS_OK)
+			fz_throw(ctx, FZ_ERROR_GENERIC, "unable to extract webp features");
+
+		info->width = features.width;
+		info->height = features.height;
+		info->xres = 72;
+		info->yres = 72;
+		info->cs = fz_keep_colorspace(ctx, fz_device_rgb(ctx));
+
+		webp_data.bytes = p;
+		webp_data.size = total;
+		demux = WebPDemux(&webp_data);
+
+		if (demux != NULL)
+		{
+			if (WebPDemuxGetI(demux, WEBP_FF_FORMAT_FLAGS) & EXIF_FLAG)
+			{
+				WebPChunkIterator chunk_iter;
+				if (WebPDemuxGetChunk(demux, "EXIF", 1, &chunk_iter))
+				{
+					extract_exif_resolution(&chunk_iter.chunk, &info->xres, &info->yres, &info->orientation);
+				}
+				WebPDemuxReleaseChunkIterator(&chunk_iter);
+			}
+			if (WebPDemuxGetI(demux, WEBP_FF_FORMAT_FLAGS) & ICCP_FLAG)
+			{
+				WebPChunkIterator chunk_iter;
+				if (WebPDemuxGetChunk(demux, "ICCP", 1, &chunk_iter))
+				{
+					info->cs = extract_icc_profile(ctx, &chunk_iter.chunk, info->cs);
+				}
+				WebPDemuxReleaseChunkIterator(&chunk_iter);
+			}
+
+			WebPDemuxDelete(demux);
+		}
+
+		if (!only_metadata)
+		{
+			uint8_t* rgba = features.has_alpha ? WebPDecodeRGBA(p, total, NULL, NULL) : WebPDecodeRGB(p, total, NULL, NULL);
+
+			if (rgba == NULL)
+				fz_throw(ctx, FZ_ERROR_GENERIC, "failed decoding webp image");
+
+			image = fz_new_pixmap(ctx, info->cs, info->width, info->height, NULL, features.has_alpha);
+			image->xres = info->xres;
+			image->yres = info->yres;
+
+			fz_clear_pixmap(ctx, image);
+			fz_unpack_tile(ctx, image, rgba, image->n, 8, image->stride, 1);
+
+			WebPFree(rgba);
+		}
+	}
+	fz_catch(ctx)
+		fz_rethrow(ctx);
+
+	return image;
+}
+
+fz_pixmap *
+fz_load_webp(fz_context *ctx, const unsigned char *p, size_t total)
+{
+	fz_pixmap *image;
+	struct info info;
+
+	fz_try(ctx)
+	{
+		image = webp_read_image(ctx, &info, p, total, 0);
+	}
+	fz_always(ctx)
+		fz_drop_colorspace(ctx, info.cs);
+	fz_catch(ctx)
+		fz_rethrow(ctx);
+
+	return image;
+}
+
+void
+fz_load_webp_info(fz_context *ctx, const unsigned char *p, size_t total, int *wp, int *hp, int *xresp, int *yresp, fz_colorspace **cspacep)
+{
+	struct info info;
+
+	fz_try(ctx)
+		webp_read_image(ctx, &info, p, total, 1);
+	fz_catch(ctx)
+	{
+		fz_drop_colorspace(ctx, info.cs);
+		fz_rethrow(ctx);
+	}
+
+	*cspacep = info.cs;
+	*wp = info.width;
+	*hp = info.height;
+	*xresp = info.xres;
+	*yresp = info.xres;
+}
diff --git a/source/html/css-apply.c b/source/html/css-apply.c
index c05c53cef..61516f767 100644
--- a/source/html/css-apply.c
+++ b/source/html/css-apply.c
@@ -879,7 +879,7 @@ number_from_value(fz_css_value *value, float initial, int initial_unit)
 		return make_number(initial, initial_unit);
 
 	if (value->type == CSS_PERCENT)
-		return make_number(fz_css_strtof(value->data, NULL), N_PERCENT);
+		return make_number(fz_css_strtof(value->data, NULL)/2.5, N_PERCENT);
 
 	if (value->type == CSS_NUMBER)
 		return make_number(fz_css_strtof(value->data, NULL), N_NUMBER);
@@ -909,13 +909,13 @@ number_from_value(fz_css_value *value, float initial, int initial_unit)
 
 		/* FIXME: 'rem' should be 'em' of root element. This is a bad approximation. */
 		if (p[0] == 'r' && p[1] == 'e' && p[2] == 'm' && p[3] == 0)
-			return make_number(x * 16, N_LENGTH);
+			return make_number(x, N_SCALE);
 
 		/* FIXME: 'ch' should be width of '0' character. This is an approximation. */
 		if (p[0] == 'c' && p[1] == 'h' && p[2] == 0)
 			return make_number(x / 2, N_LENGTH);
 
-		return make_number(x, N_LENGTH);
+		return make_number(x, N_SCALE);
 	}
 
 	if (value->type == CSS_KEYWORD)
@@ -1256,14 +1256,27 @@ fz_apply_css_style(fz_context *ctx, fz_html_font_set *set, fz_css_style *style,
 	{
 		if (!strcmp(value->data, "xx-large")) style->font_size = make_number(1.73f, N_SCALE);
 		else if (!strcmp(value->data, "x-large")) style->font_size = make_number(1.44f, N_SCALE);
+		else if (!strcmp(value->data, "xxx-large")) style->font_size = make_number(2.0f, N_SCALE);
 		else if (!strcmp(value->data, "large")) style->font_size = make_number(1.2f, N_SCALE);
 		else if (!strcmp(value->data, "medium")) style->font_size = make_number(1.0f, N_SCALE);
+		else if (!strcmp(value->data, "normal")) style->font_size = make_number(1.0f, N_SCALE);
 		else if (!strcmp(value->data, "small")) style->font_size = make_number(0.83f, N_SCALE);
 		else if (!strcmp(value->data, "x-small")) style->font_size = make_number(0.69f, N_SCALE);
-		else if (!strcmp(value->data, "xx-small")) style->font_size = make_number(0.69f, N_SCALE);
+		else if (!strcmp(value->data, "xx-small")) style->font_size = make_number(0.5f, N_SCALE);
 		else if (!strcmp(value->data, "larger")) style->font_size = make_number(1.2f, N_SCALE);
 		else if (!strcmp(value->data, "smaller")) style->font_size = make_number(1/1.2f, N_SCALE);
-		else style->font_size = number_from_value(value, 12, N_LENGTH);
+		else if (!strcmp(value->data, "inherit")) style->font_size = make_number(1.0f, N_SCALE);
+		else
+		{
+			if (value->type == CSS_PERCENT)
+			{
+				style->font_size = make_number(fz_css_strtof(value->data, NULL)/100, N_SCALE);
+			}
+			else
+			{
+				style->font_size = make_number(1, N_SCALE);
+			}
+		}
 	}
 	else
 	{
@@ -1295,19 +1308,37 @@ fz_apply_css_style(fz_context *ctx, fz_html_font_set *set, fz_css_style *style,
 
 	style->text_indent = number_from_property(match, PRO_TEXT_INDENT, 0, N_LENGTH);
 
-	style->width = number_from_property(match, PRO_WIDTH, 0, N_AUTO);
-	style->height = number_from_property(match, PRO_HEIGHT, 0, N_AUTO);
+	//style->width = number_from_property(match, PRO_WIDTH, 0, N_AUTO);
+	//style->height = number_from_property(match, PRO_HEIGHT, 0, N_AUTO);
 
 	style->margin[0] = number_from_property(match, PRO_MARGIN_TOP, 0, N_LENGTH);
 	style->margin[1] = number_from_property(match, PRO_MARGIN_RIGHT, 0, N_LENGTH);
 	style->margin[2] = number_from_property(match, PRO_MARGIN_BOTTOM, 0, N_LENGTH);
 	style->margin[3] = number_from_property(match, PRO_MARGIN_LEFT, 0, N_LENGTH);
 
+	if(style->margin[0].unit==N_SCALE && style->margin[0].value>2)style->margin[0].value=2;
+	if(style->margin[1].unit==N_SCALE && style->margin[1].value>2)style->margin[1].value=2;
+	if(style->margin[2].unit==N_SCALE && style->margin[2].value>2)style->margin[2].value=2;
+	if(style->margin[3].unit==N_SCALE && style->margin[3].value>2)style->margin[3].value=2;
+
 	style->padding[0] = number_from_property(match, PRO_PADDING_TOP, 0, N_LENGTH);
 	style->padding[1] = number_from_property(match, PRO_PADDING_RIGHT, 0, N_LENGTH);
 	style->padding[2] = number_from_property(match, PRO_PADDING_BOTTOM, 0, N_LENGTH);
 	style->padding[3] = number_from_property(match, PRO_PADDING_LEFT, 0, N_LENGTH);
 
+	style->padding[1].value = style->padding[1].value / 2;
+	style->padding[3].value = style->padding[3].value / 2;
+
+	if (style->line_height.value < 0)
+		style->line_height.value = 1.2f;
+	if (style->text_indent.value < 0)
+	{
+		if(style->text_indent.value * -1 > style->margin[3].value)
+		{
+			style->text_indent.value = -1 * style->margin[3].value;
+		}
+	}
+
 	style->color = color_from_property(match, PRO_COLOR, black);
 	style->background_color = color_from_property(match, PRO_BACKGROUND_COLOR, transparent);
 
diff --git a/source/html/epub-doc.c b/source/html/epub-doc.c
index eb0d035f9..53293e17e 100644
--- a/source/html/epub-doc.c
+++ b/source/html/epub-doc.c
@@ -576,6 +576,11 @@ rel_path_from_idref(fz_xml *manifest, const char *idref)
 		const char *id = fz_xml_att(item, "id");
 		if (id && !strcmp(id, idref))
 			return fz_xml_att(item, "href");
+
+		const char *id2 = fz_xml_att(item, "properties");
+		if (id2 && !strcmp(id2, idref))
+			return fz_xml_att(item, "href");
+
 		item = fz_xml_find_next(item, "item");
 	}
 	return NULL;
@@ -640,6 +645,103 @@ epub_parse_ncx_imp(fz_context *ctx, epub_document *doc, fz_xml *node, char *base
 	return head;
 }
 
+static fz_outline *
+epub_parse_nav_imp(fz_context *ctx, epub_document *doc, fz_xml *node, char *base_uri)
+{
+	char path[2048];
+	fz_outline *outline, *head, **tailp;
+
+	head = NULL;
+	tailp = &head;
+
+	node =  fz_xml_find_down(fz_xml_find_down(node, "ol"),"li");
+
+	while (node)
+	{
+		fz_xml *tag = fz_xml_find_down(node, "a");
+		char *text = fz_xml_text(fz_xml_down(tag));
+		if(!text){
+			text = fz_xml_text(fz_xml_down(fz_xml_down(tag)));
+		}
+		char *content = fz_xml_att(tag, "href");
+		if (text && content)
+		{
+			fz_strlcpy(path, base_uri, sizeof path);
+			fz_strlcat(path, "/", sizeof path);
+			fz_strlcat(path, content, sizeof path);
+			fz_urldecode(path);
+			fz_cleanname(path);
+
+			fz_try(ctx)
+			{
+				*tailp = outline = fz_new_outline(ctx);
+				tailp = &(*tailp)->next;
+				outline->title = fz_strdup(ctx, text);
+				outline->uri = fz_strdup(ctx, path);
+				outline->page = fz_make_location(-1, -1);
+				outline->down = epub_parse_nav_imp(ctx, doc, node, base_uri);
+			}
+			fz_catch(ctx)
+			{
+				fz_drop_outline(ctx, head);
+				fz_rethrow(ctx);
+			}
+		}
+		node = fz_xml_find_next(node, "li");
+	}
+
+	return head;
+}
+
+static void
+epub_parse_nav(fz_context *ctx, epub_document *doc, const char *path)
+{
+	fz_archive *zip = doc->zip;
+	fz_buffer *buf = NULL;
+	fz_xml_doc *ncx = NULL;
+	char base_uri[2048];
+
+	fz_var(buf);
+	fz_var(ncx);
+
+	fz_try(ctx)
+	{
+		fz_dirname(base_uri, path, sizeof base_uri);
+
+		buf = fz_read_archive_entry(ctx, zip, path);
+		ncx = fz_parse_xml(ctx, buf, 0);
+
+		fz_xml *body = fz_xml_find_down(fz_xml_root(ncx), "body");
+		fz_xml *section = fz_xml_find_down(body, "section");
+		if(section)
+		{
+			body = section;
+		}
+		fz_xml *nav = fz_xml_find_down(body, "nav");
+
+		while (nav)
+		{
+			char *id = fz_xml_att(nav, "epub:type");
+			if(!strcmp(id, "toc"))
+			{
+				doc->outline = epub_parse_nav_imp(ctx, doc, nav, base_uri);
+				break;
+			}
+			nav = fz_xml_find_next(body,"nav");
+		}
+	}
+	fz_always(ctx)
+	{
+		fz_drop_buffer(ctx, buf);
+		fz_drop_xml(ctx, ncx);
+	}
+	fz_catch(ctx)
+	{
+		fz_rethrow(ctx);
+	}
+}
+
+
 static void
 epub_parse_ncx(fz_context *ctx, epub_document *doc, const char *path)
 {
@@ -692,10 +794,10 @@ epub_parse_header(fz_context *ctx, epub_document *doc)
 	epub_chapter **tailp;
 	int i;
 
-	if (fz_has_archive_entry(ctx, zip, "META-INF/rights.xml"))
-		fz_throw(ctx, FZ_ERROR_GENERIC, "EPUB is locked by DRM");
-	if (fz_has_archive_entry(ctx, zip, "META-INF/encryption.xml"))
-		fz_throw(ctx, FZ_ERROR_GENERIC, "EPUB is locked by DRM");
+	// if (fz_has_archive_entry(ctx, zip, "META-INF/rights.xml"))
+	// 	fz_throw(ctx, FZ_ERROR_GENERIC, "EPUB is locked by DRM");
+	// if (fz_has_archive_entry(ctx, zip, "META-INF/encryption.xml"))
+	// 	fz_throw(ctx, FZ_ERROR_GENERIC, "EPUB is locked by DRM");
 
 	fz_var(buf);
 	fz_var(container_xml);
@@ -745,6 +847,10 @@ epub_parse_header(fz_context *ctx, epub_document *doc)
 		{
 			epub_parse_ncx(ctx, doc, ncx);
 		}
+		else if (path_from_idref(ncx, manifest, base_uri, "nav", sizeof ncx))
+		{
+			epub_parse_nav(ctx, doc, ncx);
+		}
 
 		doc->spine = NULL;
 		tailp = &doc->spine;
diff --git a/source/html/html-layout.c b/source/html/html-layout.c
index b3f563f43..34957e21b 100644
--- a/source/html/html-layout.c
+++ b/source/html/html-layout.c
@@ -534,6 +534,18 @@ static void layout_flow(fz_context *ctx, fz_html_box *box, fz_html_box *top, flo
 			if (node->box->style->width.unit != N_AUTO && node->box->style->height.unit == N_AUTO)
 				node->h = node->w / aspect;
 
+			int size = 50;
+			if(node->h < size)
+			{
+				node->w = node->w * size/ node->h;
+				node->h = size;
+			}
+			else
+			{
+				node->w = node->w * 2;
+				node->h = node->h * 2;
+			}
+
 			/* Shrink image to fit on one page if needed */
 			if (max_w > 0 && node->w > max_w)
 				xs = max_w / node->w;
diff --git a/source/html/html-parse.c b/source/html/html-parse.c
index 134f8f9e7..e5aab343d 100644
--- a/source/html/html-parse.c
+++ b/source/html/html-parse.c
@@ -33,7 +33,7 @@ enum { T, R, B, L };
 #define DEFAULT_DIR FZ_BIDI_LTR
 
 static const char *html_default_css =
-"@page{margin:3em 2em}"
+"@page{margin:2em 1em}"
 "a{color:#06C;text-decoration:underline}"
 "address{display:block;font-style:italic}"
 "b{font-weight:bold}"
@@ -61,45 +61,55 @@ static const char *html_default_css =
 "ins{text-decoration:underline}"
 "kbd{font-family:monospace}"
 "li{display:list-item}"
-"menu{display:block;list-style-type:disc;margin:1em 0;padding:0 0 0 30pt}"
-"ol{display:block;list-style-type:decimal;margin:1em 0;padding:0 0 0 30pt}"
-"p{display:block;margin:1em 0}"
+"menu{display:block;list-style-type:disc;margin:1em 0;padding:0 1em 0 1em}"
+"ol{display:block;list-style-type:decimal;margin:1em;padding:0 1em 0 1em}"
+"p{display:block;}"
 "pre{display:block;font-family:monospace;margin:1em 0;white-space:pre}"
 "samp{font-family:monospace}"
 "script{display:none}"
 "small{font-size:0.83em}"
+"x-small{font-size:0.6em}"
 "strong{font-weight:bold}"
 "style{display:none}"
 "sub{font-size:0.83em;vertical-align:sub}"
 "sup{font-size:0.83em;vertical-align:super}"
+
 "table{display:table}"
-"tbody{display:table-row-group}"
-"td{display:table-cell;padding:1px}"
-"tfoot{display:table-footer-group}"
-"th{display:table-cell;font-weight:bold;padding:1px;text-align:center}"
-"thead{display:table-header-group}"
-"tr{display:table-row}"
-"ul{display:block;list-style-type:disc;margin:1em 0;padding:0 0 0 30pt}"
+"tbody,tfoot,thead,tr{display:table-row}"
+"td,th{display:table-cell; text-align:left}"
+"th{font-weight:bold}"
+"td,th{font-size:0.7em !important;}"
+
+"ul{display:block;list-style-type:disc;margin:1em;padding:0 0 0 30pt}"
 "ul ul{list-style-type:circle}"
 "ul ul ul{list-style-type:square}"
 "var{font-style:italic}"
 "svg{display:none}"
+"figcaption {display:block; text-align:center}"
+"figcaption>p {text-align:center}"
+"br{display:block}"
 ;
 
 static const char *fb2_default_css =
-"@page{margin:3em 2em}"
-"FictionBook{display:block;margin:1em}"
+"@page{margin:2em 1em}"
+"FictionBook{display:block}"
 "stylesheet,binary{display:none}"
-"description>*{display:none}"
+"description,description>*{display:none}"
 "description>title-info{display:block}"
 "description>title-info>*{display:none}"
+"description>title-info>annotation{display:block;page-break-before:always;page-break-after:always}"
 "description>title-info>coverpage{display:block;page-break-before:always;page-break-after:always}"
 "body,section,title,subtitle,p,cite,epigraph,text-author,date,poem,stanza,v,empty-line{display:block}"
 "image{display:block}"
 "p>image{display:inline}"
+
 "table{display:table}"
-"tr{display:table-row}"
-"th,td{display:table-cell}"
+"tbody,tfoot,thead,tr{display:table-row}"
+"td,th{display:table-cell; text-align:left}"
+"th{font-weight:bold}"
+"td,th{font-size:0.7em !important;}"
+
+
 "a{color:#06C;text-decoration:underline}"
 "a[type=note]{font-size:small;vertical-align:super}"
 "code{white-space:pre;font-family:monospace}"
@@ -109,14 +119,14 @@ static const char *fb2_default_css =
 "sub{font-size:small;vertical-align:sub}"
 "sup{font-size:small;vertical-align:super}"
 "image{margin:1em 0;text-align:center}"
-"cite,poem{margin:1em 2em}"
+"cite,poem{margin:1em 1.5em}"
 "subtitle,epigraph,stanza{margin:1em 0}"
 "title>p{text-align:center;font-size:x-large}"
 "subtitle{text-align:center;font-size:large}"
-"p{margin-top:1em;text-align:justify}"
+"p{text-align:justify}"
 "empty-line{padding-top:1em}"
-"p+p{margin-top:0;text-indent:1.5em}"
-"empty-line+p{margin-top:0}"
+//"p+p{margin-top:0;text-indent:1.5em}"
+//"empty-line+p{margin-top:0}"
 "section>title{page-break-before:always}"
 ;
 
